# Base SysFink server install documentation.

# Upgade perl
yum upgrade perl

yum install perl-JSON

# -- Install CPAN Modules from DAG -----------------

yum install perl-DBD-SQLite

yum install perl-DateTime

yum install perl-Devel-StackTrace
yum install perl-Data-Dumper
yum install perl-SQL-Translator
yum install perl-DBIx-Class


# -- CPAN Module install to ~/sysfink-cpan -----------------
#
# See http://search.cpan.org/~andk/CPAN/lib/CPAN.pm#FAQ or 'man CPAN'.

mkdir ~/sysfink-cpan
mkdir ~/sysfink-cpan/lib
export PERL5LIB=/root/sysfink-cpan/lib

# Run 'cpan' and inside it:

o conf makepl_arg "LIB=~/sysfink-cpan/lib INSTALLMAN1DIR=~/sysfink-cpan/man/man1 INSTALLMAN3DIR=~/sysfink-cpan/man/man3 INSTALLSCRIPT=~/sysfink-cpan/bin INSTALLBIN=~/sysfink-cpan/bin"
o conf mbuildpl_arg "--lib=~/sysfink-cpan/lib --installman1dir=~/sysfink-cpan/man/man1 --installman3dir=~/sysfink-cpan/man/man3 --installscript=~/sysfink-cpan/bin --installbin=~/sysfink-cpan/bin"
o conf halt_on_failure on

install TAP::Harness

install Class::Singleton

install Spiffy
install DateTime::Locale
install DateTime::TimeZone
install DateTime

install JSON

install Data::Compare

install Config::Multi

install Test::Tester
install DBIx::Class

install Net::OpenSSH
install YAML::Any
install YAML::XS

# For some devel utils.
# install SQL::Translator

exit

# You should call e.g. 'export PERL5LIB=/root/sysfink-cpan/lib' before running any SysFink command.


# -- SySFink  ----------------------------------------------

# Login as root to server machine.
# Check out ~/sysfink if not exists: svn co http://sysfink.googlecode.com/svn/trunk ~/sysfink


# -- Client ------------------------------------------------

cd ~/sysfink/client

perl t/harness.pl


# -- Server ------------------------------------------------

cd ~/sysfink/server

# Create/edit server config files.
cp conf/web.yml.example conf/web.yml
cp conf/web_db.yml.example conf/web_db.yml

# Create client's machine config files
cat > conf-machines/my-first-machine
hostname    my-first-machine.my-domain.com
dist_type   linux-perl-md5
ssh_user    root
exclude     /dev/ /home/ /proc/ /sys/ /var/ /mnt/

[fastscan]
exclude     /
include     /etc
<Ctrl+D>

# Create empty db file
cp sysfink-empty.db sysfink.db

# Run SysFink servers' tests
perl t/harness.pl

# Check if you can run SysFink server utility.
perl sysfink.pl --help

# Load config files to database
perl sysfink.pl --cmd=mconf_to_db

# Import server SSH key/certificate for user 'root' to my-first-machine.my-domain.com

# Run first test command on client machine.
perl sysfink.pl --host=my-first-machine --cmd=test_hostname

# Debug or monitor with more verbose output (--ver=4 to --ver=10).
perl sysfink.pl --host=my-first-machine --cmd=test_hostname --ver=10

# Run rest of test command on you client.
perl sysfink.pl --host=my-first-machine --cmd=check_client_dir
perl sysfink.pl --host=my-first-machine --cmd=remove_client_dir
perl sysfink.pl --host=my-first-machine --cmd=renew_client_dir
perl sysfink.pl --host=my-first-machine --cmd=test_noop_rpc
perl sysfink.pl --host=my-first-machine --cmd=test_three_parts_rpc

# Finally run scan testing command. These can take a while.
# Consider to use --section=fastscan if you have this in machine config.
perl sysfink.pl --host=my-first-machine --cmd=scan_test --section=fastscan
perl sysfink.pl --host=my-first-machine --cmd=scan_test

# Renew SysFink source code again (if you are paranoid enought) and run the first
# normal scan command.
perl sysfink.pl --host=my-first-machine --cmd=renew_client_dir
perl sysfink.pl --host=my-first-machine --cmd=scan

