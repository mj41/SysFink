=== Header ===

<!-- perl utils\wiki_schema.pl sql\schema.wiki 1 > sql\schema.sql -->
<!-- PARSE PART DBCREATE BEGIN -->
<source lang=sql>
-- schema revision: $LastChangedRevision: 358 $
SET FOREIGN_KEY_CHECKS=0;
begin transaction;

-- Tags_order: Config, Machine, User.
</source>

=== Tables ===

==== Table machine (m) ====
<source lang=sql>
CREATE TABLE machine (
    machine_id      INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    name            VARCHAR(50) NOT NULL,
    `desc`          TEXT DEFAULT NULL COMMENT 'Description.',
    ip              VARCHAR(15) DEFAULT NUL,
    disabled        BOOLEAN NOT NULL DEFAULT 0
) TYPE=InnoDB COMMENT='Machine (computer or virtual machine) info. Tag:Machine.';
</source>

==== Table mconf ====
<source lang=sql>
CREATE TABLE mconf (
    mconf_sec_id    INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    machine_id      INT UNSIGNED NOT NULL,
    active          INT UNSIGNED NOT NULL,
    create_time     DATETIME NOT NULL,
    CONSTRAINT fk_mconf_machine_id FOREIGN KEY (machine_id) REFERENCES machine (machine_id)
) TYPE=InnoDB COMMENT='Machine configuratio. Tag:Machine.';
</source>

==== Table mconf_sec ====
<source lang=sql>
CREATE TABLE mconf_sec (
    mconf_sec_id    INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    mconf_id        INT UNSIGNED NOT NULL,
    name            VARCHAR(50) NOT NULL,
    CONSTRAINT fk_mconf_sec_mconf_id FOREIGN KEY (mconf_id) REFERENCES mconf (mconf_id)
) TYPE=InnoDB COMMENT='Machine configuratio section. Tag:Machine.';
</source>

==== Table mconf_sec_kv ====
<source lang=sql>
CREATE TABLE mconf_sec_kv (
    mconf_sec_kv_id     INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    mconf_sec_id        INT UNSIGNED NOT NULL,
    num                 INT UNSIGNED DEFAULT NULL,
    `key`               VARCHAR(50) NOT NULL,
    value               VARCHAR(255) NOT NULL,
    CONSTRAINT fk_mconf_sec_kv_mconf_sec_id FOREIGN KEY (mconf_sec_id) REFERENCES mconf_sec (mconf_sec_id)
) TYPE=InnoDB COMMENT='Machine configuration section key and value pairs. Tag:Machine.';
</source>

=== Table scan (sc) ===
<source lang=sql>
CREATE TABLE scan (
    scan_id         INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    mconf_id        INT UNSIGNED NOT NULL,
    start_time      DATETIME NOT NULL,
    stop_time       DATETIME DEFAULT NULL,
    pid             INT UNSIGNED NOT NULL COMMENT 'OS process id of scanning process.',
    items           INT UNSIGNED DEFAULT NULL COMMENT 'Number of items found during the scan.',
    CONSTRAINT fk_scan_mconf_id FOREIGN KEY (mconf_id) REFERENCES mconf (mconf_id)
) TYPE=InnoDB COMMENT='Machine scan. Tag:Scan.';
</source>

=== Table sc_mitem ===
<source lang=sql>
CREATE TABLE sc_mitem (
    sc_mitem_id         INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    machine_id          INT UNSIGNED NOT NULL,
    path                VARCHAR(255) NOT NULL,
    CONSTRAINT fk_sc_mitem_machine_id FOREIGN KEY (machine_id) REFERENCES machine (machine_id)
) TYPE=InnoDB COMMENT='Machine paths (all history). Tag:Scan.';
</source>

=== Table sc_idata ===
<source lang=sql>
CREATE TABLE sc_idata (
    sc_idata_id     INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    sc_mitem_id     INT UNSIGNED NOT NULL,
    scan_id         INT UNSIGNED NOT NULL,
    newer_id        INT UNSIGNED DEFAULT NULL,
    found           INT UNSIGNED NOT NULL,
    mtime           DATETIME DEFAULT NULL,
    mode            INT UNSIGNED DEFAULT NULL,
    size            INT UNSIGNED DEFAULT NULL,
    uid             INT UNSIGNED DEFAULT NULL,
    user_name       VARCHAR(50) DEFAULT NULL,
    gid             INT UNSIGNED DEFAULT NULL,
    group_name      VARCHAR(50) DEFAULT NULL,
    hash            VARCHAR(32) DEFAULT NULL,
    nlink           INT UNSIGNED DEFAULT NULL,
    dev_num         INT UNSIGNED DEFAULT NULL,
    ino_num         INT UNSIGNED DEFAULT NULL,
    CONSTRAINT fk_sc_idata_sc_mitem_id FOREIGN KEY (sc_mitem_id) REFERENCES sc_mitem (sc_mitem_id),
    CONSTRAINT fk_sc_idata_scan_id FOREIGN KEY (scan_id) REFERENCES scan (scan_id),
    CONSTRAINT fk_sc_idata_newer_id FOREIGN KEY (newer_id) REFERENCES sc_idata (sc_idata_id)
) TYPE=InnoDB COMMENT='Machine scan item data. Tag:Scan.';
</source>

==== Table user ====
<source lang=sql>
CREATE TABLE user (
    user_id     INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY COMMENT 'Primary key',
    login       VARCHAR(20) NOT NULL,
    passwd      VARCHAR(20) NOT NULL,
    first_name  VARCHAR(255) NOT NULL DEFAULT '',
    last_name   VARCHAR(255) NOT NULL DEFAULT '',
    active      BOOLEAN NOT NULL DEFAULT 1 COMMENT 'Zero means historical data.',
    created     DATETIME NOT NULL COMMENT 'Account creation time.',
    INDEX i_login (login)
) TYPE=InnoDB COMMENT='User info. Tag:User.';
</source>

=== Footer ===

<source lang=sql>
commit;
</source>
<!-- PARSE PART DBCREATE END -->
